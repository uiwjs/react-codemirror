"use strict";var view=require("@codemirror/view"),state=require("@codemirror/state"),elt=require("crelt");class SelectedDiagnostic{constructor(t,e,i){this.from=t,this.to=e,this.diagnostic=i}}class LintState{constructor(t,e,i){this.diagnostics=t,this.panel=e,this.selected=i}static init(t,e,i){let n=i.facet(lintConfig).markerFilter;n&&(t=n(t,i));let o=t.slice().sort((t,e)=>t.from-e.from||t.to-e.to),s=new state.RangeSetBuilder,l=[],a=0;for(let c=0;;){let t,e,n=c==o.length?null:o[c];if(!n&&!l.length)break;for(l.length?(t=a,e=l.reduce((t,e)=>Math.min(t,e.to),n&&n.from>t?n.from:1e8)):(t=n.from,e=n.to,l.push(n),c++);c<o.length;){let i=o[c];if(i.from!=t||!(i.to>i.from||i.to==t)){e=Math.min(i.from,e);break}l.push(i),c++,e=Math.min(i.to,e)}let r=maxSeverity(l);if(l.some(t=>t.from==t.to||t.from==t.to-1&&i.doc.lineAt(t.from).to==t.from))s.add(t,t,view.Decoration.widget({widget:new DiagnosticWidget(r),diagnostics:l.slice()}));else{let i=l.reduce((t,e)=>e.markClass?t+" "+e.markClass:t,"");s.add(t,e,view.Decoration.mark({class:"cm-lintRange cm-lintRange-"+r+i,diagnostics:l.slice(),inclusiveEnd:l.some(t=>t.to>e)}))}a=e;for(let i=0;i<l.length;i++)l[i].to<=a&&l.splice(i--,1)}let r=s.finish();return new LintState(r,e,findDiagnostic(r))}}function findDiagnostic(t,e=null,i=0){let n=null;return t.between(i,1e9,(t,i,{spec:o})=>{if(!(e&&o.diagnostics.indexOf(e)<0))if(n){if(o.diagnostics.indexOf(n.diagnostic)<0)return!1;n=new SelectedDiagnostic(n.from,i,n.diagnostic)}else n=new SelectedDiagnostic(t,i,e||o.diagnostics[0])}),n}function hideTooltip(t,e){let i=e.pos,n=e.end||i,o=t.state.facet(lintConfig).hideOn(t,i,n);if(null!=o)return o;let s=t.startState.doc.lineAt(e.pos);return!(!t.effects.some(t=>t.is(setDiagnosticsEffect))&&!t.changes.touchesRange(s.from,Math.max(s.to,n)))}function maybeEnableLint(t,e){return t.field(lintState,!1)?e:e.concat(state.StateEffect.appendConfig.of(lintExtensions))}function setDiagnostics(t,e){return{effects:maybeEnableLint(t,[setDiagnosticsEffect.of(e)])}}const setDiagnosticsEffect=state.StateEffect.define(),togglePanel=state.StateEffect.define(),movePanelSelection=state.StateEffect.define(),lintState=state.StateField.define({create:()=>new LintState(view.Decoration.none,null,null),update(t,e){if(e.docChanged&&t.diagnostics.size){let i=t.diagnostics.map(e.changes),n=null,o=t.panel;if(t.selected){let o=e.changes.mapPos(t.selected.from,1);n=findDiagnostic(i,t.selected.diagnostic,o)||findDiagnostic(i,null,o)}!i.size&&o&&e.state.facet(lintConfig).autoPanel&&(o=null),t=new LintState(i,o,n)}for(let i of e.effects)if(i.is(setDiagnosticsEffect)){let n=e.state.facet(lintConfig).autoPanel?i.value.length?LintPanel.open:null:t.panel;t=LintState.init(i.value,n,e.state)}else i.is(togglePanel)?t=new LintState(t.diagnostics,i.value?LintPanel.open:null,t.selected):i.is(movePanelSelection)&&(t=new LintState(t.diagnostics,t.panel,i.value));return t},provide:t=>[view.showPanel.from(t,t=>t.panel),view.EditorView.decorations.from(t,t=>t.diagnostics)]});function diagnosticCount(t){let e=t.field(lintState,!1);return e?e.diagnostics.size:0}const activeMark=view.Decoration.mark({class:"cm-lintRange cm-lintRange-active"});function lintTooltip(t,e,i){let n,{diagnostics:o}=t.state.field(lintState),s=-1,l=-1;o.between(e-(i<0?1:0),e+(i>0?1:0),(t,o,{spec:a})=>{if(e>=t&&e<=o&&(t==o||(e>t||i>0)&&(e<o||i<0)))return n=a.diagnostics,s=t,l=o,!1});let a=t.state.facet(lintConfig).tooltipFilter;return n&&a&&(n=a(n,t.state)),n?{pos:s,end:l,above:t.state.doc.lineAt(s).to<l,create:()=>({dom:diagnosticsTooltip(t,n)})}:null}function diagnosticsTooltip(t,e){return elt("ul",{class:"cm-tooltip-lint"},e.map(e=>renderDiagnostic(t,e,!1)))}const openLintPanel=t=>{let e=t.state.field(lintState,!1);e&&e.panel||t.dispatch({effects:maybeEnableLint(t.state,[togglePanel.of(!0)])});let i=view.getPanel(t,LintPanel.open);return i&&i.dom.querySelector(".cm-panel-lint ul").focus(),!0},closeLintPanel=t=>{let e=t.state.field(lintState,!1);return!(!e||!e.panel)&&(t.dispatch({effects:togglePanel.of(!1)}),!0)},nextDiagnostic=t=>{let e=t.state.field(lintState,!1);if(!e)return!1;let i=t.state.selection.main,n=e.diagnostics.iter(i.to+1);return!(!n.value&&(n=e.diagnostics.iter(0),!n.value||n.from==i.from&&n.to==i.to))&&(t.dispatch({selection:{anchor:n.from,head:n.to},scrollIntoView:!0}),!0)},previousDiagnostic=t=>{let{state:e}=t,i=e.field(lintState,!1);if(!i)return!1;let n,o,s,l,a=e.selection.main;return i.diagnostics.between(0,e.doc.length,(t,e)=>{e<a.to&&(null==n||n<t)&&(n=t,o=e),(null==s||t>s)&&(s=t,l=e)}),null!=s&&(null!=n||s!=a.from)&&(t.dispatch({selection:{anchor:null!==n&&void 0!==n?n:s,head:null!==o&&void 0!==o?o:l},scrollIntoView:!0}),!0)},lintKeymap=[{key:"Mod-Shift-m",run:openLintPanel,preventDefault:!0},{key:"F8",run:nextDiagnostic}],lintPlugin=view.ViewPlugin.fromClass(class{constructor(t){this.view=t,this.timeout=-1,this.set=!0;let{delay:e}=t.state.facet(lintConfig);this.lintTime=Date.now()+e,this.run=this.run.bind(this),this.timeout=setTimeout(this.run,e)}run(){clearTimeout(this.timeout);let t=Date.now();if(t<this.lintTime-10)this.timeout=setTimeout(this.run,this.lintTime-t);else{this.set=!1;let{state:t}=this.view,{sources:e}=t.facet(lintConfig);e.length&&batchResults(e.map(t=>Promise.resolve(t(this.view))),e=>{this.view.state.doc==t.doc&&this.view.dispatch(setDiagnostics(this.view.state,e.reduce((t,e)=>t.concat(e))))},t=>{view.logException(this.view.state,t)})}}update(t){let e=t.state.facet(lintConfig);(t.docChanged||e!=t.startState.facet(lintConfig)||e.needsRefresh&&e.needsRefresh(t))&&(this.lintTime=Date.now()+e.delay,this.set||(this.set=!0,this.timeout=setTimeout(this.run,e.delay)))}force(){this.set&&(this.lintTime=Date.now(),this.run())}destroy(){clearTimeout(this.timeout)}});function batchResults(t,e,i){let n=[],o=-1;for(let s of t)s.then(i=>{n.push(i),clearTimeout(o),n.length==t.length?e(n):o=setTimeout(()=>e(n),200)},i)}const lintConfig=state.Facet.define({combine:t=>Object.assign({sources:t.map(t=>t.source).filter(t=>null!=t)},state.combineConfig(t.map(t=>t.config),{delay:750,markerFilter:null,tooltipFilter:null,needsRefresh:null,hideOn:()=>null},{needsRefresh:(t,e)=>t?e?i=>t(i)||e(i):t:e}))});function linter(t,e={}){return[lintConfig.of({source:t,config:e}),lintPlugin,lintExtensions]}function forceLinting(t){let e=t.plugin(lintPlugin);e&&e.force()}function assignKeys(t){let e=[];if(t)t:for(let{name:i}of t){for(let t=0;t<i.length;t++){let n=i[t];if(/[a-zA-Z]/.test(n)&&!e.some(t=>t.toLowerCase()==n.toLowerCase())){e.push(n);continue t}}e.push("")}return e}function renderDiagnostic(t,e,i){var n;let o=i?assignKeys(e.actions):[];return elt("li",{class:"cm-diagnostic cm-diagnostic-"+e.severity},elt("span",{class:"cm-diagnosticText"},e.renderMessage?e.renderMessage(t):e.message),null===(n=e.actions)||void 0===n?void 0:n.map((i,n)=>{let s=!1,l=n=>{if(n.preventDefault(),s)return;s=!0;let o=findDiagnostic(t.state.field(lintState).diagnostics,e);o&&i.apply(t,o.from,o.to)},{name:a}=i,r=o[n]?a.indexOf(o[n]):-1,c=r<0?a:[a.slice(0,r),elt("u",a.slice(r,r+1)),a.slice(r+1)];return elt("button",{type:"button",class:"cm-diagnosticAction",onclick:l,onmousedown:l,"aria-label":` Action: ${a}${r<0?"":` (access key "${o[n]})"`}.`},c)}),e.source&&elt("div",{class:"cm-diagnosticSource"},e.source))}class DiagnosticWidget extends view.WidgetType{constructor(t){super(),this.sev=t}eq(t){return t.sev==this.sev}toDOM(){return elt("span",{class:"cm-lintPoint cm-lintPoint-"+this.sev})}}class PanelItem{constructor(t,e){this.diagnostic=e,this.id="item_"+Math.floor(4294967295*Math.random()).toString(16),this.dom=renderDiagnostic(t,e,!0),this.dom.id=this.id,this.dom.setAttribute("role","option")}}class LintPanel{constructor(t){this.view=t,this.items=[];this.list=elt("ul",{tabIndex:0,role:"listbox","aria-label":this.view.state.phrase("Diagnostics"),onkeydown:e=>{if(27==e.keyCode)closeLintPanel(this.view),this.view.focus();else if(38==e.keyCode||33==e.keyCode)this.moveSelection((this.selectedIndex-1+this.items.length)%this.items.length);else if(40==e.keyCode||34==e.keyCode)this.moveSelection((this.selectedIndex+1)%this.items.length);else if(36==e.keyCode)this.moveSelection(0);else if(35==e.keyCode)this.moveSelection(this.items.length-1);else if(13==e.keyCode)this.view.focus();else{if(!(e.keyCode>=65&&e.keyCode<=90&&this.selectedIndex>=0))return;{let{diagnostic:i}=this.items[this.selectedIndex],n=assignKeys(i.actions);for(let o=0;o<n.length;o++)if(n[o].toUpperCase().charCodeAt(0)==e.keyCode){let e=findDiagnostic(this.view.state.field(lintState).diagnostics,i);e&&i.actions[o].apply(t,e.from,e.to)}}}e.preventDefault()},onclick:t=>{for(let e=0;e<this.items.length;e++)this.items[e].dom.contains(t.target)&&this.moveSelection(e)}}),this.dom=elt("div",{class:"cm-panel-lint"},this.list,elt("button",{type:"button",name:"close","aria-label":this.view.state.phrase("close"),onclick:()=>closeLintPanel(this.view)},"\xd7")),this.update()}get selectedIndex(){let t=this.view.state.field(lintState).selected;if(!t)return-1;for(let e=0;e<this.items.length;e++)if(this.items[e].diagnostic==t.diagnostic)return e;return-1}update(){let{diagnostics:t,selected:e}=this.view.state.field(lintState),i=0,n=!1,o=null,s=new Set;for(t.between(0,this.view.state.doc.length,(t,l,{spec:a})=>{for(let r of a.diagnostics){if(s.has(r))continue;s.add(r);let t,l=-1;for(let e=i;e<this.items.length;e++)if(this.items[e].diagnostic==r){l=e;break}l<0?(t=new PanelItem(this.view,r),this.items.splice(i,0,t),n=!0):(t=this.items[l],l>i&&(this.items.splice(i,l-i),n=!0)),e&&t.diagnostic==e.diagnostic?t.dom.hasAttribute("aria-selected")||(t.dom.setAttribute("aria-selected","true"),o=t):t.dom.hasAttribute("aria-selected")&&t.dom.removeAttribute("aria-selected"),i++}});i<this.items.length&&!(1==this.items.length&&this.items[0].diagnostic.from<0);)n=!0,this.items.pop();0==this.items.length&&(this.items.push(new PanelItem(this.view,{from:-1,to:-1,severity:"info",message:this.view.state.phrase("No diagnostics")})),n=!0),o?(this.list.setAttribute("aria-activedescendant",o.id),this.view.requestMeasure({key:this,read:()=>({sel:o.dom.getBoundingClientRect(),panel:this.list.getBoundingClientRect()}),write:({sel:t,panel:e})=>{let i=e.height/this.list.offsetHeight;t.top<e.top?this.list.scrollTop-=(e.top-t.top)/i:t.bottom>e.bottom&&(this.list.scrollTop+=(t.bottom-e.bottom)/i)}})):this.selectedIndex<0&&this.list.removeAttribute("aria-activedescendant"),n&&this.sync()}sync(){let t=this.list.firstChild;function e(){let e=t;t=e.nextSibling,e.remove()}for(let i of this.items)if(i.dom.parentNode==this.list){for(;t!=i.dom;)e();t=i.dom.nextSibling}else this.list.insertBefore(i.dom,t);for(;t;)e()}moveSelection(t){if(this.selectedIndex<0)return;let e=findDiagnostic(this.view.state.field(lintState).diagnostics,this.items[t].diagnostic);e&&this.view.dispatch({selection:{anchor:e.from,head:e.to},scrollIntoView:!0,effects:movePanelSelection.of(e)})}static open(t){return new LintPanel(t)}}function svg(t,e='viewBox="0 0 40 40"'){return`url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" ${e}>${encodeURIComponent(t)}</svg>')`}function underline(t){return svg(`<path d="m0 2.5 l2 -1.5 l1 0 l2 1.5 l1 0" stroke="${t}" fill="none" stroke-width=".7"/>`,'width="6" height="3"')}const baseTheme=view.EditorView.baseTheme({".cm-diagnostic":{padding:"3px 6px 3px 8px",marginLeft:"-1px",display:"block",whiteSpace:"pre-wrap"},".cm-diagnostic-error":{borderLeft:"5px solid #d11"},".cm-diagnostic-warning":{borderLeft:"5px solid orange"},".cm-diagnostic-info":{borderLeft:"5px solid #999"},".cm-diagnostic-hint":{borderLeft:"5px solid #66d"},".cm-diagnosticAction":{font:"inherit",border:"none",padding:"2px 4px",backgroundColor:"#444",color:"white",borderRadius:"3px",marginLeft:"8px",cursor:"pointer"},".cm-diagnosticSource":{fontSize:"70%",opacity:.7},".cm-lintRange":{backgroundPosition:"left bottom",backgroundRepeat:"repeat-x",paddingBottom:"0.7px"},".cm-lintRange-error":{backgroundImage:underline("#d11")},".cm-lintRange-warning":{backgroundImage:underline("orange")},".cm-lintRange-info":{backgroundImage:underline("#999")},".cm-lintRange-hint":{backgroundImage:underline("#66d")},".cm-lintRange-active":{backgroundColor:"#ffdd9980"},".cm-tooltip-lint":{padding:0,margin:0},".cm-lintPoint":{position:"relative","&:after":{content:'""',position:"absolute",bottom:0,left:"-2px",borderLeft:"3px solid transparent",borderRight:"3px solid transparent",borderBottom:"4px solid #d11"}},".cm-lintPoint-warning":{"&:after":{borderBottomColor:"orange"}},".cm-lintPoint-info":{"&:after":{borderBottomColor:"#999"}},".cm-lintPoint-hint":{"&:after":{borderBottomColor:"#66d"}},".cm-panel.cm-panel-lint":{position:"relative","& ul":{maxHeight:"100px",overflowY:"auto","& [aria-selected]":{backgroundColor:"#ddd","& u":{textDecoration:"underline"}},"&:focus [aria-selected]":{background_fallback:"#bdf",backgroundColor:"Highlight",color_fallback:"white",color:"HighlightText"},"& u":{textDecoration:"none"},padding:0,margin:0},"& [name=close]":{position:"absolute",top:"0",right:"2px",background:"inherit",border:"none",font:"inherit",padding:0,margin:0}}});function severityWeight(t){return"error"==t?4:"warning"==t?3:"info"==t?2:1}function maxSeverity(t){let e="hint",i=1;for(let n of t){let t=severityWeight(n.severity);t>i&&(i=t,e=n.severity)}return e}class LintGutterMarker extends view.GutterMarker{constructor(t){super(),this.diagnostics=t,this.severity=maxSeverity(t)}toDOM(t){let e=document.createElement("div");e.className="cm-lint-marker cm-lint-marker-"+this.severity;let i=this.diagnostics,n=t.state.facet(lintGutterConfig).tooltipFilter;return n&&(i=n(i,t.state)),i.length&&(e.onmouseover=()=>gutterMarkerMouseOver(t,e,i)),e}}function trackHoverOn(t,e){let i=n=>{let o=e.getBoundingClientRect();if(!(n.clientX>o.left-10&&n.clientX<o.right+10&&n.clientY>o.top-10&&n.clientY<o.bottom+10)){for(let t=n.target;t;t=t.parentNode)if(1==t.nodeType&&t.classList.contains("cm-tooltip-lint"))return;window.removeEventListener("mousemove",i),t.state.field(lintGutterTooltip)&&t.dispatch({effects:setLintGutterTooltip.of(null)})}};window.addEventListener("mousemove",i)}function gutterMarkerMouseOver(t,e,i){function n(){let n=t.elementAtHeight(e.getBoundingClientRect().top+5-t.documentTop);t.coordsAtPos(n.from)&&t.dispatch({effects:setLintGutterTooltip.of({pos:n.from,above:!1,clip:!1,create:()=>({dom:diagnosticsTooltip(t,i),getCoords:()=>e.getBoundingClientRect()})})}),e.onmouseout=e.onmousemove=null,trackHoverOn(t,e)}let{hoverTime:o}=t.state.facet(lintGutterConfig),s=setTimeout(n,o);e.onmouseout=()=>{clearTimeout(s),e.onmouseout=e.onmousemove=null},e.onmousemove=()=>{clearTimeout(s),s=setTimeout(n,o)}}function markersForDiagnostics(t,e){let i=Object.create(null);for(let o of e){let e=t.lineAt(o.from);(i[e.from]||(i[e.from]=[])).push(o)}let n=[];for(let o in i)n.push(new LintGutterMarker(i[o]).range(+o));return state.RangeSet.of(n,!0)}const lintGutterExtension=view.gutter({class:"cm-gutter-lint",markers:t=>t.state.field(lintGutterMarkers),widgetMarker:(t,e,i)=>{let n=[];return t.state.field(lintGutterMarkers).between(i.from,i.to,(t,e,o)=>{t>i.from&&t<i.to&&n.push(...o.diagnostics)}),n.length?new LintGutterMarker(n):null}}),lintGutterMarkers=state.StateField.define({create:()=>state.RangeSet.empty,update(t,e){t=t.map(e.changes);let i=e.state.facet(lintGutterConfig).markerFilter;for(let n of e.effects)if(n.is(setDiagnosticsEffect)){let o=n.value;i&&(o=i(o||[],e.state)),t=markersForDiagnostics(e.state.doc,o.slice(0))}return t}}),setLintGutterTooltip=state.StateEffect.define(),lintGutterTooltip=state.StateField.define({create:()=>null,update:(t,e)=>(t&&e.docChanged&&(t=hideTooltip(e,t)?null:Object.assign(Object.assign({},t),{pos:e.changes.mapPos(t.pos)})),e.effects.reduce((t,e)=>e.is(setLintGutterTooltip)?e.value:t,t)),provide:t=>view.showTooltip.from(t)}),lintGutterTheme=view.EditorView.baseTheme({".cm-gutter-lint":{width:"1.4em","& .cm-gutterElement":{padding:".2em"}},".cm-lint-marker":{width:"1em",height:"1em"},".cm-lint-marker-info":{content:svg('<path fill="#aaf" stroke="#77e" stroke-width="6" stroke-linejoin="round" d="M5 5L35 5L35 35L5 35Z"/>')},".cm-lint-marker-warning":{content:svg('<path fill="#fe8" stroke="#fd7" stroke-width="6" stroke-linejoin="round" d="M20 6L37 35L3 35Z"/>')},".cm-lint-marker-error":{content:svg('<circle cx="20" cy="20" r="15" fill="#f87" stroke="#f43" stroke-width="6"/>')}}),lintExtensions=[lintState,view.EditorView.decorations.compute([lintState],t=>{let{selected:e,panel:i}=t.field(lintState);return e&&i&&e.from!=e.to?view.Decoration.set([activeMark.range(e.from,e.to)]):view.Decoration.none}),view.hoverTooltip(lintTooltip,{hideOn:hideTooltip}),baseTheme],lintGutterConfig=state.Facet.define({combine:t=>state.combineConfig(t,{hoverTime:300,markerFilter:null,tooltipFilter:null})});function lintGutter(t={}){return[lintGutterConfig.of(t),lintGutterMarkers,lintGutterExtension,lintGutterTheme,lintGutterTooltip]}function forEachDiagnostic(t,e){let i=t.field(lintState,!1);if(i&&i.diagnostics.size){let t=[],n=[],o=-1;for(let s=state.RangeSet.iter([i.diagnostics]);;s.next()){for(let i=0;i<t.length;i++)(!s.value||s.value.spec.diagnostics.indexOf(t[i])<0)&&(e(t[i],n[i],o),t.splice(i,1),n.splice(i--,1));if(!s.value)break;for(let e of s.value.spec.diagnostics)t.indexOf(e)<0&&(t.push(e),n.push(s.from));o=s.to}}}exports.closeLintPanel=closeLintPanel,exports.diagnosticCount=diagnosticCount,exports.forEachDiagnostic=forEachDiagnostic,exports.forceLinting=forceLinting,exports.lintGutter=lintGutter,exports.lintKeymap=lintKeymap,exports.linter=linter,exports.nextDiagnostic=nextDiagnostic,exports.openLintPanel=openLintPanel,exports.previousDiagnostic=previousDiagnostic,exports.setDiagnostics=setDiagnostics,exports.setDiagnosticsEffect=setDiagnosticsEffect;