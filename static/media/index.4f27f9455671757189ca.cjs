"use strict";var view=require("@codemirror/view"),state=require("@codemirror/state"),elt=require("crelt");const basicNormalize="function"==typeof String.prototype.normalize?e=>e.normalize("NFKD"):e=>e;class SearchCursor{constructor(e,t,r=0,i=e.length,s,n){this.test=n,this.value={from:0,to:0},this.done=!1,this.matches=[],this.buffer="",this.bufferPos=0,this.iter=e.iterRange(r,i),this.bufferStart=r,this.normalize=s?e=>s(basicNormalize(e)):basicNormalize,this.query=this.normalize(t)}peek(){if(this.bufferPos==this.buffer.length){if(this.bufferStart+=this.buffer.length,this.iter.next(),this.iter.done)return-1;this.bufferPos=0,this.buffer=this.iter.value}return state.codePointAt(this.buffer,this.bufferPos)}next(){for(;this.matches.length;)this.matches.pop();return this.nextOverlapping()}nextOverlapping(){for(;;){let e=this.peek();if(e<0)return this.done=!0,this;let t=state.fromCodePoint(e),r=this.bufferStart+this.bufferPos;this.bufferPos+=state.codePointSize(e);let i=this.normalize(t);if(i.length)for(let s=0,n=r;;s++){let e=i.charCodeAt(s),a=this.match(e,n,this.bufferPos+this.bufferStart);if(s==i.length-1){if(a)return this.value=a,this;break}n==r&&s<t.length&&t.charCodeAt(s)==e&&n++}}}match(e,t,r){let i=null;for(let s=0;s<this.matches.length;s+=2){let t=this.matches[s],n=!1;this.query.charCodeAt(t)==e&&(t==this.query.length-1?i={from:this.matches[s+1],to:r}:(this.matches[s]++,n=!0)),n||(this.matches.splice(s,2),s-=2)}return this.query.charCodeAt(0)==e&&(1==this.query.length?i={from:t,to:r}:this.matches.push(1,t)),i&&this.test&&!this.test(i.from,i.to,this.buffer,this.bufferStart)&&(i=null),i}}"undefined"!=typeof Symbol&&(SearchCursor.prototype[Symbol.iterator]=function(){return this});const empty={from:-1,to:-1,match:/.*/.exec("")},baseFlags="gm"+(null==/x/.unicode?"":"u");class RegExpCursor{constructor(e,t,r,i=0,s=e.length){if(this.text=e,this.to=s,this.curLine="",this.done=!1,this.value=empty,/\\[sWDnr]|\n|\r|\[\^/.test(t))return new MultilineRegExpCursor(e,t,r,i,s);this.re=new RegExp(t,baseFlags+((null===r||void 0===r?void 0:r.ignoreCase)?"i":"")),this.test=null===r||void 0===r?void 0:r.test,this.iter=e.iter();let n=e.lineAt(i);this.curLineStart=n.from,this.matchPos=toCharEnd(e,i),this.getLine(this.curLineStart)}getLine(e){this.iter.next(e),this.iter.lineBreak?this.curLine="":(this.curLine=this.iter.value,this.curLineStart+this.curLine.length>this.to&&(this.curLine=this.curLine.slice(0,this.to-this.curLineStart)),this.iter.next())}nextLine(){this.curLineStart=this.curLineStart+this.curLine.length+1,this.curLineStart>this.to?this.curLine="":this.getLine(0)}next(){for(let e=this.matchPos-this.curLineStart;;){this.re.lastIndex=e;let t=this.matchPos<=this.to&&this.re.exec(this.curLine);if(t){let r=this.curLineStart+t.index,i=r+t[0].length;if(this.matchPos=toCharEnd(this.text,i+(r==i?1:0)),r==this.curLineStart+this.curLine.length&&this.nextLine(),(r<i||r>this.value.to)&&(!this.test||this.test(r,i,t)))return this.value={from:r,to:i,match:t},this;e=this.matchPos-this.curLineStart}else{if(!(this.curLineStart+this.curLine.length<this.to))return this.done=!0,this;this.nextLine(),e=0}}}}const flattened=new WeakMap;class FlattenedDoc{constructor(e,t){this.from=e,this.text=t}get to(){return this.from+this.text.length}static get(e,t,r){let i=flattened.get(e);if(!i||i.from>=r||i.to<=t){let i=new FlattenedDoc(t,e.sliceString(t,r));return flattened.set(e,i),i}if(i.from==t&&i.to==r)return i;let{text:s,from:n}=i;return n>t&&(s=e.sliceString(t,n)+s,n=t),i.to<r&&(s+=e.sliceString(i.to,r)),flattened.set(e,new FlattenedDoc(n,s)),new FlattenedDoc(t,s.slice(t-n,r-n))}}class MultilineRegExpCursor{constructor(e,t,r,i,s){this.text=e,this.to=s,this.done=!1,this.value=empty,this.matchPos=toCharEnd(e,i),this.re=new RegExp(t,baseFlags+((null===r||void 0===r?void 0:r.ignoreCase)?"i":"")),this.test=null===r||void 0===r?void 0:r.test,this.flat=FlattenedDoc.get(e,i,this.chunkEnd(i+5e3))}chunkEnd(e){return e>=this.to?this.to:this.text.lineAt(e).to}next(){for(;;){let e=this.re.lastIndex=this.matchPos-this.flat.from,t=this.re.exec(this.flat.text);if(t&&!t[0]&&t.index==e&&(this.re.lastIndex=e+1,t=this.re.exec(this.flat.text)),t){let e=this.flat.from+t.index,r=e+t[0].length;if((this.flat.to>=this.to||t.index+t[0].length<=this.flat.text.length-10)&&(!this.test||this.test(e,r,t)))return this.value={from:e,to:r,match:t},this.matchPos=toCharEnd(this.text,r+(e==r?1:0)),this}if(this.flat.to==this.to)return this.done=!0,this;this.flat=FlattenedDoc.get(this.text,this.flat.from,this.chunkEnd(this.flat.from+2*this.flat.text.length))}}}function validRegExp(e){try{return new RegExp(e,baseFlags),!0}catch(t){return!1}}function toCharEnd(e,t){if(t>=e.length)return t;let r,i=e.lineAt(t);for(;t<i.to&&(r=i.text.charCodeAt(t-i.from))>=56320&&r<57344;)t++;return t}"undefined"!=typeof Symbol&&(RegExpCursor.prototype[Symbol.iterator]=MultilineRegExpCursor.prototype[Symbol.iterator]=function(){return this});const gotoLine=e=>{let{state:t}=e,r=String(t.doc.lineAt(e.state.selection.main.head).number),{close:i,result:s}=view.showDialog(e,{label:t.phrase("Go to line"),input:{type:"text",name:"line",value:r},focus:!0,submitLabel:t.phrase("go")});return s.then(r=>{let s=r&&/^([+-])?(\d+)?(:\d+)?(%)?$/.exec(r.elements.line.value);if(!s)return void e.dispatch({effects:i});let n=t.doc.lineAt(t.selection.main.head),[,a,o,c,l]=s,h=c?+c.slice(1):0,u=o?+o:n.number;if(o&&l){let e=u/100;a&&(e=e*("-"==a?-1:1)+n.number/t.doc.lines),u=Math.round(t.doc.lines*e)}else o&&a&&(u=u*("-"==a?-1:1)+n.number);let d=t.doc.line(Math.max(1,Math.min(t.doc.lines,u))),f=state.EditorSelection.cursor(d.from+Math.max(0,Math.min(h,d.length)));e.dispatch({effects:[i,view.EditorView.scrollIntoView(f.from,{y:"center"})],selection:f})}),!0},defaultHighlightOptions={highlightWordAroundCursor:!1,minSelectionLength:1,maxMatches:100,wholeWords:!1},highlightConfig=state.Facet.define({combine:e=>state.combineConfig(e,defaultHighlightOptions,{highlightWordAroundCursor:(e,t)=>e||t,minSelectionLength:Math.min,maxMatches:Math.min})});function highlightSelectionMatches(e){let t=[defaultTheme,matchHighlighter];return e&&t.push(highlightConfig.of(e)),t}const matchDeco=view.Decoration.mark({class:"cm-selectionMatch"}),mainMatchDeco=view.Decoration.mark({class:"cm-selectionMatch cm-selectionMatch-main"});function insideWordBoundaries(e,t,r,i){return(0==r||e(t.sliceDoc(r-1,r))!=state.CharCategory.Word)&&(i==t.doc.length||e(t.sliceDoc(i,i+1))!=state.CharCategory.Word)}function insideWord(e,t,r,i){return e(t.sliceDoc(r,r+1))==state.CharCategory.Word&&e(t.sliceDoc(i-1,i))==state.CharCategory.Word}const matchHighlighter=view.ViewPlugin.fromClass(class{constructor(e){this.decorations=this.getDeco(e)}update(e){(e.selectionSet||e.docChanged||e.viewportChanged)&&(this.decorations=this.getDeco(e.view))}getDeco(e){let t=e.state.facet(highlightConfig),{state:r}=e,i=r.selection;if(i.ranges.length>1)return view.Decoration.none;let s,n=i.main,a=null;if(n.empty){if(!t.highlightWordAroundCursor)return view.Decoration.none;let e=r.wordAt(n.head);if(!e)return view.Decoration.none;a=r.charCategorizer(n.head),s=r.sliceDoc(e.from,e.to)}else{let e=n.to-n.from;if(e<t.minSelectionLength||e>200)return view.Decoration.none;if(t.wholeWords){if(s=r.sliceDoc(n.from,n.to),a=r.charCategorizer(n.head),!insideWordBoundaries(a,r,n.from,n.to)||!insideWord(a,r,n.from,n.to))return view.Decoration.none}else if(s=r.sliceDoc(n.from,n.to),!s)return view.Decoration.none}let o=[];for(let c of e.visibleRanges){let e=new SearchCursor(r.doc,s,c.from,c.to);for(;!e.next().done;){let{from:i,to:s}=e.value;if((!a||insideWordBoundaries(a,r,i,s))&&(n.empty&&i<=n.from&&s>=n.to?o.push(mainMatchDeco.range(i,s)):(i>=n.to||s<=n.from)&&o.push(matchDeco.range(i,s)),o.length>t.maxMatches))return view.Decoration.none}}return view.Decoration.set(o)}},{decorations:e=>e.decorations}),defaultTheme=view.EditorView.baseTheme({".cm-selectionMatch":{backgroundColor:"#99ff7780"},".cm-searchMatch .cm-selectionMatch":{backgroundColor:"transparent"}}),selectWord=({state:e,dispatch:t})=>{let{selection:r}=e,i=state.EditorSelection.create(r.ranges.map(t=>e.wordAt(t.head)||state.EditorSelection.cursor(t.head)),r.mainIndex);return!i.eq(r)&&(t(e.update({selection:i})),!0)};function findNextOccurrence(e,t){let{main:r,ranges:i}=e.selection,s=e.wordAt(r.head),n=s&&s.from==r.from&&s.to==r.to;for(let a=!1,o=new SearchCursor(e.doc,t,i[i.length-1].to);;){if(o.next(),!o.done){if(a&&i.some(e=>e.from==o.value.from))continue;if(n){let t=e.wordAt(o.value.from);if(!t||t.from!=o.value.from||t.to!=o.value.to)continue}return o.value}if(a)return null;o=new SearchCursor(e.doc,t,0,Math.max(0,i[i.length-1].from-1)),a=!0}}const selectNextOccurrence=({state:e,dispatch:t})=>{let{ranges:r}=e.selection;if(r.some(e=>e.from===e.to))return selectWord({state:e,dispatch:t});let i=e.sliceDoc(r[0].from,r[0].to);if(e.selection.ranges.some(t=>e.sliceDoc(t.from,t.to)!=i))return!1;let s=findNextOccurrence(e,i);return!!s&&(t(e.update({selection:e.selection.addRange(state.EditorSelection.range(s.from,s.to),!1),effects:view.EditorView.scrollIntoView(s.to)})),!0)},searchConfigFacet=state.Facet.define({combine:e=>state.combineConfig(e,{top:!1,caseSensitive:!1,literal:!1,regexp:!1,wholeWord:!1,createPanel:e=>new SearchPanel(e),scrollToMatch:e=>view.EditorView.scrollIntoView(e)})});function search(e){return e?[searchConfigFacet.of(e),searchExtensions]:searchExtensions}class SearchQuery{constructor(e){this.search=e.search,this.caseSensitive=!!e.caseSensitive,this.literal=!!e.literal,this.regexp=!!e.regexp,this.replace=e.replace||"",this.valid=!!this.search&&(!this.regexp||validRegExp(this.search)),this.unquoted=this.unquote(this.search),this.wholeWord=!!e.wholeWord,this.test=e.test}unquote(e){return this.literal?e:e.replace(/\\([nrt\\])/g,(e,t)=>"n"==t?"\n":"r"==t?"\r":"t"==t?"\t":"\\")}eq(e){return this.search==e.search&&this.replace==e.replace&&this.caseSensitive==e.caseSensitive&&this.regexp==e.regexp&&this.wholeWord==e.wholeWord&&this.test==e.test}create(){return this.regexp?new RegExpQuery(this):new StringQuery(this)}getCursor(e,t=0,r){let i=e.doc?e:state.EditorState.create({doc:e});return null==r&&(r=i.doc.length),this.regexp?regexpCursor(this,i,t,r):stringCursor(this,i,t,r)}}class QueryType{constructor(e){this.spec=e}}function wrapStringTest(e,t,r){return(i,s,n,a)=>{if(r&&!r(i,s,n,a))return!1;let o=i>=a&&s<=a+n.length?n.slice(i-a,s-a):t.doc.sliceString(i,s);return e(o,t,i,s)}}function stringCursor(e,t,r,i){let s;return e.wholeWord&&(s=stringWordTest(t.doc,t.charCategorizer(t.selection.main.head))),e.test&&(s=wrapStringTest(e.test,t,s)),new SearchCursor(t.doc,e.unquoted,r,i,e.caseSensitive?void 0:e=>e.toLowerCase(),s)}function stringWordTest(e,t){return(r,i,s,n)=>((n>r||n+s.length<i)&&(n=Math.max(0,r-2),s=e.sliceString(n,Math.min(e.length,i+2))),(t(charBefore(s,r-n))!=state.CharCategory.Word||t(charAfter(s,r-n))!=state.CharCategory.Word)&&(t(charAfter(s,i-n))!=state.CharCategory.Word||t(charBefore(s,i-n))!=state.CharCategory.Word))}class StringQuery extends QueryType{constructor(e){super(e)}nextMatch(e,t,r){let i=stringCursor(this.spec,e,r,e.doc.length).nextOverlapping();if(i.done){let r=Math.min(e.doc.length,t+this.spec.unquoted.length);i=stringCursor(this.spec,e,0,r).nextOverlapping()}return i.done||i.value.from==t&&i.value.to==r?null:i.value}prevMatchInRange(e,t,r){for(let i=r;;){let r=Math.max(t,i-1e4-this.spec.unquoted.length),s=stringCursor(this.spec,e,r,i),n=null;for(;!s.nextOverlapping().done;)n=s.value;if(n)return n;if(r==t)return null;i-=1e4}}prevMatch(e,t,r){let i=this.prevMatchInRange(e,0,t);return i||(i=this.prevMatchInRange(e,Math.max(0,r-this.spec.unquoted.length),e.doc.length)),!i||i.from==t&&i.to==r?null:i}getReplacement(e){return this.spec.unquote(this.spec.replace)}matchAll(e,t){let r=stringCursor(this.spec,e,0,e.doc.length),i=[];for(;!r.next().done;){if(i.length>=t)return null;i.push(r.value)}return i}highlight(e,t,r,i){let s=stringCursor(this.spec,e,Math.max(0,t-this.spec.unquoted.length),Math.min(r+this.spec.unquoted.length,e.doc.length));for(;!s.next().done;)i(s.value.from,s.value.to)}}function wrapRegexpTest(e,t,r){return(i,s,n)=>(!r||r(i,s,n))&&e(n[0],t,i,s)}function regexpCursor(e,t,r,i){let s;return e.wholeWord&&(s=regexpWordTest(t.charCategorizer(t.selection.main.head))),e.test&&(s=wrapRegexpTest(e.test,t,s)),new RegExpCursor(t.doc,e.search,{ignoreCase:!e.caseSensitive,test:s},r,i)}function charBefore(e,t){return e.slice(state.findClusterBreak(e,t,!1),t)}function charAfter(e,t){return e.slice(t,state.findClusterBreak(e,t))}function regexpWordTest(e){return(t,r,i)=>!i[0].length||(e(charBefore(i.input,i.index))!=state.CharCategory.Word||e(charAfter(i.input,i.index))!=state.CharCategory.Word)&&(e(charAfter(i.input,i.index+i[0].length))!=state.CharCategory.Word||e(charBefore(i.input,i.index+i[0].length))!=state.CharCategory.Word)}class RegExpQuery extends QueryType{nextMatch(e,t,r){let i=regexpCursor(this.spec,e,r,e.doc.length).next();return i.done&&(i=regexpCursor(this.spec,e,0,t).next()),i.done?null:i.value}prevMatchInRange(e,t,r){for(let i=1;;i++){let s=Math.max(t,r-1e4*i),n=regexpCursor(this.spec,e,s,r),a=null;for(;!n.next().done;)a=n.value;if(a&&(s==t||a.from>s+10))return a;if(s==t)return null}}prevMatch(e,t,r){return this.prevMatchInRange(e,0,t)||this.prevMatchInRange(e,r,e.doc.length)}getReplacement(e){return this.spec.unquote(this.spec.replace).replace(/\$([$&]|\d+)/g,(t,r)=>{if("&"==r)return e.match[0];if("$"==r)return"$";for(let i=r.length;i>0;i--){let t=+r.slice(0,i);if(t>0&&t<e.match.length)return e.match[t]+r.slice(i)}return t})}matchAll(e,t){let r=regexpCursor(this.spec,e,0,e.doc.length),i=[];for(;!r.next().done;){if(i.length>=t)return null;i.push(r.value)}return i}highlight(e,t,r,i){let s=regexpCursor(this.spec,e,Math.max(0,t-250),Math.min(r+250,e.doc.length));for(;!s.next().done;)i(s.value.from,s.value.to)}}const setSearchQuery=state.StateEffect.define(),togglePanel=state.StateEffect.define(),searchState=state.StateField.define({create:e=>new SearchState(defaultQuery(e).create(),null),update(e,t){for(let r of t.effects)r.is(setSearchQuery)?e=new SearchState(r.value.create(),e.panel):r.is(togglePanel)&&(e=new SearchState(e.query,r.value?createSearchPanel:null));return e},provide:e=>view.showPanel.from(e,e=>e.panel)});function getSearchQuery(e){let t=e.field(searchState,!1);return t?t.query.spec:defaultQuery(e)}function searchPanelOpen(e){var t;return null!=(null===(t=e.field(searchState,!1))||void 0===t?void 0:t.panel)}class SearchState{constructor(e,t){this.query=e,this.panel=t}}const matchMark=view.Decoration.mark({class:"cm-searchMatch"}),selectedMatchMark=view.Decoration.mark({class:"cm-searchMatch cm-searchMatch-selected"}),searchHighlighter=view.ViewPlugin.fromClass(class{constructor(e){this.view=e,this.decorations=this.highlight(e.state.field(searchState))}update(e){let t=e.state.field(searchState);(t!=e.startState.field(searchState)||e.docChanged||e.selectionSet||e.viewportChanged)&&(this.decorations=this.highlight(t))}highlight({query:e,panel:t}){if(!t||!e.spec.valid)return view.Decoration.none;let{view:r}=this,i=new state.RangeSetBuilder;for(let s=0,n=r.visibleRanges,a=n.length;s<a;s++){let{from:t,to:o}=n[s];for(;s<a-1&&o>n[s+1].from-500;)o=n[++s].to;e.highlight(r.state,t,o,(e,t)=>{let s=r.state.selection.ranges.some(r=>r.from==e&&r.to==t);i.add(e,t,s?selectedMatchMark:matchMark)})}return i.finish()}},{decorations:e=>e.decorations});function searchCommand(e){return t=>{let r=t.state.field(searchState,!1);return r&&r.query.spec.valid?e(t,r):openSearchPanel(t)}}const findNext=searchCommand((e,{query:t})=>{let{to:r}=e.state.selection.main,i=t.nextMatch(e.state,r,r);if(!i)return!1;let s=state.EditorSelection.single(i.from,i.to),n=e.state.facet(searchConfigFacet);return e.dispatch({selection:s,effects:[announceMatch(e,i),n.scrollToMatch(s.main,e)],userEvent:"select.search"}),selectSearchInput(e),!0}),findPrevious=searchCommand((e,{query:t})=>{let{state:r}=e,{from:i}=r.selection.main,s=t.prevMatch(r,i,i);if(!s)return!1;let n=state.EditorSelection.single(s.from,s.to),a=e.state.facet(searchConfigFacet);return e.dispatch({selection:n,effects:[announceMatch(e,s),a.scrollToMatch(n.main,e)],userEvent:"select.search"}),selectSearchInput(e),!0}),selectMatches=searchCommand((e,{query:t})=>{let r=t.matchAll(e.state,1e3);return!(!r||!r.length)&&(e.dispatch({selection:state.EditorSelection.create(r.map(e=>state.EditorSelection.range(e.from,e.to))),userEvent:"select.search.matches"}),!0)}),selectSelectionMatches=({state:e,dispatch:t})=>{let r=e.selection;if(r.ranges.length>1||r.main.empty)return!1;let{from:i,to:s}=r.main,n=[],a=0;for(let o=new SearchCursor(e.doc,e.sliceDoc(i,s));!o.next().done;){if(n.length>1e3)return!1;o.value.from==i&&(a=n.length),n.push(state.EditorSelection.range(o.value.from,o.value.to))}return t(e.update({selection:state.EditorSelection.create(n,a),userEvent:"select.search.matches"})),!0},replaceNext=searchCommand((e,{query:t})=>{let{state:r}=e,{from:i,to:s}=r.selection.main;if(r.readOnly)return!1;let n=t.nextMatch(r,i,i);if(!n)return!1;let a,o,c=n,l=[],h=[];c.from==i&&c.to==s&&(o=r.toText(t.getReplacement(c)),l.push({from:c.from,to:c.to,insert:o}),c=t.nextMatch(r,c.from,c.to),h.push(view.EditorView.announce.of(r.phrase("replaced match on line $",r.doc.lineAt(i).number)+".")));let u=e.state.changes(l);return c&&(a=state.EditorSelection.single(c.from,c.to).map(u),h.push(announceMatch(e,c)),h.push(r.facet(searchConfigFacet).scrollToMatch(a.main,e))),e.dispatch({changes:u,selection:a,effects:h,userEvent:"input.replace"}),!0}),replaceAll=searchCommand((e,{query:t})=>{if(e.state.readOnly)return!1;let r=t.matchAll(e.state,1e9).map(e=>{let{from:r,to:i}=e;return{from:r,to:i,insert:t.getReplacement(e)}});if(!r.length)return!1;let i=e.state.phrase("replaced $ matches",r.length)+".";return e.dispatch({changes:r,effects:view.EditorView.announce.of(i),userEvent:"input.replace.all"}),!0});function createSearchPanel(e){return e.state.facet(searchConfigFacet).createPanel(e)}function defaultQuery(e,t){var r,i,s,n,a;let o=e.selection.main,c=o.empty||o.to>o.from+100?"":e.sliceDoc(o.from,o.to);if(t&&!c)return t;let l=e.facet(searchConfigFacet);return new SearchQuery({search:(null!==(r=null===t||void 0===t?void 0:t.literal)&&void 0!==r?r:l.literal)?c:c.replace(/\n/g,"\\n"),caseSensitive:null!==(i=null===t||void 0===t?void 0:t.caseSensitive)&&void 0!==i?i:l.caseSensitive,literal:null!==(s=null===t||void 0===t?void 0:t.literal)&&void 0!==s?s:l.literal,regexp:null!==(n=null===t||void 0===t?void 0:t.regexp)&&void 0!==n?n:l.regexp,wholeWord:null!==(a=null===t||void 0===t?void 0:t.wholeWord)&&void 0!==a?a:l.wholeWord})}function getSearchInput(e){let t=view.getPanel(e,createSearchPanel);return t&&t.dom.querySelector("[main-field]")}function selectSearchInput(e){let t=getSearchInput(e);t&&t==e.root.activeElement&&t.select()}const openSearchPanel=e=>{let t=e.state.field(searchState,!1);if(t&&t.panel){let r=getSearchInput(e);if(r&&r!=e.root.activeElement){let i=defaultQuery(e.state,t.query.spec);i.valid&&e.dispatch({effects:setSearchQuery.of(i)}),r.focus(),r.select()}}else e.dispatch({effects:[togglePanel.of(!0),t?setSearchQuery.of(defaultQuery(e.state,t.query.spec)):state.StateEffect.appendConfig.of(searchExtensions)]});return!0},closeSearchPanel=e=>{let t=e.state.field(searchState,!1);if(!t||!t.panel)return!1;let r=view.getPanel(e,createSearchPanel);return r&&r.dom.contains(e.root.activeElement)&&e.focus(),e.dispatch({effects:togglePanel.of(!1)}),!0},searchKeymap=[{key:"Mod-f",run:openSearchPanel,scope:"editor search-panel"},{key:"F3",run:findNext,shift:findPrevious,scope:"editor search-panel",preventDefault:!0},{key:"Mod-g",run:findNext,shift:findPrevious,scope:"editor search-panel",preventDefault:!0},{key:"Escape",run:closeSearchPanel,scope:"editor search-panel"},{key:"Mod-Shift-l",run:selectSelectionMatches},{key:"Mod-Alt-g",run:gotoLine},{key:"Mod-d",run:selectNextOccurrence,preventDefault:!0}];class SearchPanel{constructor(e){this.view=e;let t=this.query=e.state.field(searchState).query.spec;function r(e,t,r){return elt("button",{class:"cm-button",name:e,onclick:t,type:"button"},r)}this.commit=this.commit.bind(this),this.searchField=elt("input",{value:t.search,placeholder:phrase(e,"Find"),"aria-label":phrase(e,"Find"),class:"cm-textfield",name:"search",form:"","main-field":"true",onchange:this.commit,onkeyup:this.commit}),this.replaceField=elt("input",{value:t.replace,placeholder:phrase(e,"Replace"),"aria-label":phrase(e,"Replace"),class:"cm-textfield",name:"replace",form:"",onchange:this.commit,onkeyup:this.commit}),this.caseField=elt("input",{type:"checkbox",name:"case",form:"",checked:t.caseSensitive,onchange:this.commit}),this.reField=elt("input",{type:"checkbox",name:"re",form:"",checked:t.regexp,onchange:this.commit}),this.wordField=elt("input",{type:"checkbox",name:"word",form:"",checked:t.wholeWord,onchange:this.commit}),this.dom=elt("div",{onkeydown:e=>this.keydown(e),class:"cm-search"},[this.searchField,r("next",()=>findNext(e),[phrase(e,"next")]),r("prev",()=>findPrevious(e),[phrase(e,"previous")]),r("select",()=>selectMatches(e),[phrase(e,"all")]),elt("label",null,[this.caseField,phrase(e,"match case")]),elt("label",null,[this.reField,phrase(e,"regexp")]),elt("label",null,[this.wordField,phrase(e,"by word")]),...e.state.readOnly?[]:[elt("br"),this.replaceField,r("replace",()=>replaceNext(e),[phrase(e,"replace")]),r("replaceAll",()=>replaceAll(e),[phrase(e,"replace all")])],elt("button",{name:"close",onclick:()=>closeSearchPanel(e),"aria-label":phrase(e,"close"),type:"button"},["\xd7"])])}commit(){let e=new SearchQuery({search:this.searchField.value,caseSensitive:this.caseField.checked,regexp:this.reField.checked,wholeWord:this.wordField.checked,replace:this.replaceField.value});e.eq(this.query)||(this.query=e,this.view.dispatch({effects:setSearchQuery.of(e)}))}keydown(e){view.runScopeHandlers(this.view,e,"search-panel")?e.preventDefault():13==e.keyCode&&e.target==this.searchField?(e.preventDefault(),(e.shiftKey?findPrevious:findNext)(this.view)):13==e.keyCode&&e.target==this.replaceField&&(e.preventDefault(),replaceNext(this.view))}update(e){for(let t of e.transactions)for(let e of t.effects)e.is(setSearchQuery)&&!e.value.eq(this.query)&&this.setQuery(e.value)}setQuery(e){this.query=e,this.searchField.value=e.search,this.replaceField.value=e.replace,this.caseField.checked=e.caseSensitive,this.reField.checked=e.regexp,this.wordField.checked=e.wholeWord}mount(){this.searchField.select()}get pos(){return 80}get top(){return this.view.state.facet(searchConfigFacet).top}}function phrase(e,t){return e.state.phrase(t)}const AnnounceMargin=30,Break=/[\s\.,:;?!]/;function announceMatch(e,{from:t,to:r}){let i=e.state.doc.lineAt(t),s=e.state.doc.lineAt(r).to,n=Math.max(i.from,t-AnnounceMargin),a=Math.min(s,r+AnnounceMargin),o=e.state.sliceDoc(n,a);if(n!=i.from)for(let c=0;c<AnnounceMargin;c++)if(!Break.test(o[c+1])&&Break.test(o[c])){o=o.slice(c);break}if(a!=s)for(let c=o.length-1;c>o.length-AnnounceMargin;c--)if(!Break.test(o[c-1])&&Break.test(o[c])){o=o.slice(0,c);break}return view.EditorView.announce.of(`${e.state.phrase("current match")}. ${o} ${e.state.phrase("on line")} ${i.number}.`)}const baseTheme=view.EditorView.baseTheme({".cm-panel.cm-search":{padding:"2px 6px 4px",position:"relative","& [name=close]":{position:"absolute",top:"0",right:"4px",backgroundColor:"inherit",border:"none",font:"inherit",padding:0,margin:0},"& input, & button, & label":{margin:".2em .6em .2em 0"},"& input[type=checkbox]":{marginRight:".2em"},"& label":{fontSize:"80%",whiteSpace:"pre"}},"&light .cm-searchMatch":{backgroundColor:"#ffff0054"},"&dark .cm-searchMatch":{backgroundColor:"#00ffff8a"},"&light .cm-searchMatch-selected":{backgroundColor:"#ff6a0054"},"&dark .cm-searchMatch-selected":{backgroundColor:"#ff00ff8a"}}),searchExtensions=[searchState,state.Prec.low(searchHighlighter),baseTheme];exports.RegExpCursor=RegExpCursor,exports.SearchCursor=SearchCursor,exports.SearchQuery=SearchQuery,exports.closeSearchPanel=closeSearchPanel,exports.findNext=findNext,exports.findPrevious=findPrevious,exports.getSearchQuery=getSearchQuery,exports.gotoLine=gotoLine,exports.highlightSelectionMatches=highlightSelectionMatches,exports.openSearchPanel=openSearchPanel,exports.replaceAll=replaceAll,exports.replaceNext=replaceNext,exports.search=search,exports.searchKeymap=searchKeymap,exports.searchPanelOpen=searchPanelOpen,exports.selectMatches=selectMatches,exports.selectNextOccurrence=selectNextOccurrence,exports.selectSelectionMatches=selectSelectionMatches,exports.setSearchQuery=setSearchQuery;